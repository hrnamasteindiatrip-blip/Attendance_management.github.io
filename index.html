```jsx
/*
README
=====
KailashSchedule Component
- Displays departure schedules for Kailash Mansarovar tours, grouped by route.
- Data-driven: Edit the DATA const to update routes, dates, durations.
- Customization:
  - Labels/Placeholders: Modify render strings for prices (e.g., '$2,500'), seats (e.g., '15'), or add dynamic props.
  - Full Moon Hints: Edit "fullMoonHint" in DATA; component parses for marking.
  - Default Year: Computed as current year + 1; override via year prop.
- Exports: CSV for filtered list; per-departure ICS download or Google Calendar link.
- Filters: Route, month, search, full-moon toggle.
- Accessibility: Semantic elements, ARIA labels, keyboard-navigable.
- Validation: Console warns on invalid dates (e.g., Feb 30).
- Usage: See example at bottom. Requires Tailwind CSS in parent app.
*/

import React, { useState, useMemo } from 'react';

const monthMap = {
  Jan: 1, Feb: 2, Mar: 3, Apr: 4, May: 5, Jun: 6,
  Jul: 7, Aug: 8, Sep: 9, Oct: 10, Nov: 11, Dec: 12
};

const DATA = {
  "routes": [
    {
      "id": "land_kerung",
      "title": "Land Route (Ex-Nepal â€“ Kerung Border)",
      "duration": "13 Nights / 14 Days",
      "dates": [
        {"md": "May-24", "fullMoonHint": "31 May"},
        {"md": "May-31", "fullMoonHint": "31 May"},
        {"md": "Jun-02", "fullMoonHint": "29 Jun"},
        {"md": "Jun-15", "fullMoonHint": "29 Jun"},
        {"md": "Jun-22", "fullMoonHint": "29 Jun"},
        {"md": "Jul-04", "fullMoonHint": "10 Jul"},
        {"md": "Jul-15", "fullMoonHint": null},
        {"md": "Jul-22", "fullMoonHint": "29 Jul"},
        {"md": "Aug-15", "fullMoonHint": null},
        {"md": "Aug-21", "fullMoonHint": "28 Aug"},
        {"md": "Sep-04", "fullMoonHint": null},
        {"md": "Sep-19", "fullMoonHint": "26 Sep"}
      ]
    },
    {
      "id": "heli_lucknow",
      "title": "Heli Route (Ex-Lucknow/Nepalgunj)",
      "duration": "8 Nights / 9 Days",
      "dates": [
        {"md": "May-26", "fullMoonHint": "31 May"},
        {"md": "Jun-24", "fullMoonHint": "29 Jun"},
        {"md": "Jul-24", "fullMoonHint": "29 Jul"},
        {"md": "Aug-05", "fullMoonHint": "28 Aug"},
        {"md": "Aug-15", "fullMoonHint": null},
        {"md": "Aug-23", "fullMoonHint": "28 Aug"},
        {"md": "Sep-05", "fullMoonHint": "26 Sep"},
        {"md": "Sep-22", "fullMoonHint": "26 Sep"}
      ]
    },
    {
      "id": "heli_kathmandu",
      "title": "Heli Route (Ex-Kathmandu)",
      "duration": "10 Nights / 11 Days",
      "dates": [
        {"md": "May-25", "fullMoonHint": "31 May"},
        {"md": "Jun-23", "fullMoonHint": "29 Jun"},
        {"md": "Jul-23", "fullMoonHint": "29 Jul"},
        {"md": "Aug-04", "fullMoonHint": "28 Aug"},
        {"md": "Aug-14", "fullMoonHint": null},
        {"md": "Aug-22", "fullMoonHint": "28 Aug"},
        {"md": "Sep-04", "fullMoonHint": null},
        {"md": "Sep-21", "fullMoonHint": "26 Sep"}
      ]
    }
  ]
};

// Helper: Parse md + year to date object, validate, compute fields
function computeDatesForRoute(route, year) {
  return route.dates
    .map(d => {
      const [monthStr, dayStr] = d.md.split('-');
      const month = monthMap[monthStr];
      const day = parseInt(dayStr, 10);
      if (!month || isNaN(day) || day < 1 || day > 31) {
        console.warn(`Invalid md format: ${d.md}`);
        return null;
      }
      const date = new Date(year, month - 1, day);
      if (
        isNaN(date.getTime()) ||
        date.getMonth() !== month - 1 ||
        date.getDate() !== day
      ) {
        console.warn(`Invalid date: ${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`);
        return null;
      }
      const iso = date.toISOString().split('T')[0];
      const formatted = date.toLocaleDateString('en-US', {
        month: 'long',
        day: 'numeric',
        year: 'numeric'
      });
      const weekday = date.toLocaleDateString('en-US', { weekday: 'long' });
      let isFullMoon = false;
      let fullMoonHint = null;
      if (d.fullMoonHint) {
        fullMoonHint = d.fullMoonHint;
        const fmParts = d.fullMoonHint.split(' ');
        const fmDay = parseInt(fmParts[0], 10);
        if (fmDay === day) {
          isFullMoon = true;
        }
      }
      return { date, iso, formatted, weekday, isFullMoon, fullMoonHint };
    })
    .filter(Boolean)
    .sort((a, b) => a.date.getTime() - b.date.getTime());
}

// Helper: Generate and download ICS for all-day event
function downloadICS(event) {
  const start = event.start.replace(/-/g, '');
  const dtstamp = new Date().toISOString().replace(/[:-]/g, '').split('.')[0] + 'Z';
  const uid = `kailash-${Date.now()}@example.com`;
  let summary = event.summary.replace(/,/g, '\\,').replace(/;/g, '\\;').replace(/\n/g, '\\n');
  let description = event.details.replace(/,/g, '\\,').replace(/;/g, '\\;').replace(/\n/g, '\\n');
  const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//xAI//Kailash Schedule//EN
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${dtstamp}
DTSTART;VALUE=DATE:${start}
SUMMARY:${summary}
DESCRIPTION:${description}
END:VEVENT
END:VCALENDAR`;
  const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `kailash_departure_${event.start}.ics`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

// Helper: Open Google Calendar event link
function openGoogleCalendar(event) {
  const startDate = new Date(event.start + 'T00:00:00');
  const endDate = new Date(startDate.getTime() + 86400000);
  const startStr = startDate.toISOString().slice(0, 10).replace(/-/g, '');
  const endStr = endDate.toISOString().slice(0, 10).replace(/-/g, '');
  const text = encodeURIComponent(event.summary);
  const details = encodeURIComponent(event.details);
  const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${startStr}/${endStr}&details=${details}`;
  window.open(url, '_blank');
}

// Helper: Generate and download CSV
function downloadCSV(rows, filename) {
  if (rows.length === 0) return;
  const headers = Object.keys(rows[0]);
  const csvContent = [
    headers.join(','),
    ...rows.map(row => headers.map(header => JSON.stringify(row[header] || '')).join(','))
  ].join('\n');
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

const KailashSchedule = ({ year, onBook }) => {
  const effectiveYear = year || new Date().getFullYear() + 1;

  const [selectedRoute, setSelectedRoute] = useState('');
  const [selectedMonth, setSelectedMonth] = useState('');
  const [searchTerm, setSearchTerm] = useState('');
  const [onlyFullMoon, setOnlyFullMoon] = useState(false);

  const allMonths = useMemo(() => {
    const months = new Set();
    DATA.routes.forEach(r => {
      r.dates.forEach(d => {
        const monthStr = d.md.split('-')[0];
        months.add(monthStr);
      });
    });
    return Array.from(months).sort((a, b) => (monthMap[a] || 0) - (monthMap[b] || 0));
  }, []);

  const filteredRoutes = useMemo(() => {
    return DATA.routes
      .filter(r => !selectedRoute || r.id === selectedRoute)
      .map(r => {
        const computedDates = computeDatesForRoute(r, effectiveYear);
        const filteredDates = computedDates.filter(d => {
          if (onlyFullMoon && !d.isFullMoon) return false;
          const monthName = d.date.toLocaleDateString('en-US', { month: 'long' });
          if (selectedMonth && monthName !== selectedMonth) return false;
          if (searchTerm && !d.formatted.toLowerCase().includes(searchTerm.toLowerCase())) return false;
          return true;
        });
        return { ...r, computedDates, filteredDates };
      });
  }, [effectiveYear, selectedRoute, selectedMonth, searchTerm, onlyFullMoon]);

  const handleExportCSV = () => {
    const allFiltered = filteredRoutes.flatMap(r =>
      r.filteredDates.map(d => ({
        Route: r.title,
        Date: d.formatted,
        Weekday: d.weekday,
        'Full Moon': d.isFullMoon ? 'Yes' : 'No',
        'Seats Left': '15', // TODO: Customize seats (e.g., dynamic from API or data)
        Price: '$2,500' // TODO: Customize prices (e.g., per route/date)
      }))
    );
    if (allFiltered.length === 0) {
      console.warn('No departures to export');
      return;
    }
    downloadCSV(allFiltered, `kailash_departures_${effectiveYear}.csv`);
  };

  const handleBook = dateObj => {
    onBook?.(dateObj);
  };

  return (
    <div className="container mx-auto p-4 max-w-7xl">
      <h1 className="text-3xl font-bold mb-6 text-center sm:text-left">Kailash Mansarovar Departure Schedules</h1>
      <div className="flex flex-wrap items-center gap-4 mb-6 bg-gray-50 p-4 rounded-lg">
        <select
          value={selectedRoute}
          onChange={e => setSelectedRoute(e.target.value)}
          className="border border-gray-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
          aria-label="Filter by route"
        >
          <option value="">All Routes</option>
          {DATA.routes.map(r => (
            <option key={r.id} value={r.id}>
              {r.title.split(' (')[0].trim()}
            </option>
          ))}
        </select>
        <select
          value={selectedMonth}
          onChange={e => setSelectedMonth(e.target.value)}
          className="border border-gray-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
          aria-label="Filter by month"
        >
          <option value="">All Months</option>
          {allMonths.map(m => (
            <option key={m} value={m}>
              {m}
            </option>
          ))}
        </select>
        <input
          type="text"
          placeholder="Search dates..."
          value={searchTerm}
          onChange={e => setSearchTerm(e.target.value)}
          className="border border-gray-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 flex-1 min-w-[200px]"
          aria-label="Search departures"
        />
        <label className="flex items-center gap-2 cursor-pointer">
          <input
            type="checkbox"
            checked={onlyFullMoon}
            onChange={e => setOnlyFullMoon(e.target.checked)}
            className="rounded"
          />
          <span className="text-sm">Only Full-Moon</span>
        </label>
        <button
          onClick={handleExportCSV}
          className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 ml-auto"
          aria-label="Export filtered departures to CSV"
        >
          Export CSV
        </button>
      </div>
      {filteredRoutes.length === 0 ? (
        <p className="text-center text-gray-500">No routes match the filters.</p>
      ) : (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {filteredRoutes.map(route => (
            <section
              key={route.id}
              className="bg-white shadow-md rounded-lg p-6 border border-gray-200"
              aria-labelledby={`route-title-${route.id}`}
            >
              <h2 id={`route-title-${route.id}`} className="text-xl font-semibold mb-2">
                {route.title}
              </h2>
              <p className="text-gray-600 mb-4 text-sm">{route.duration}</p>
              {route.filteredDates.length === 0 ? (
                <p className="text-gray-500 text-center py-4">No departures match the filters.</p>
              ) : (
                <div role="list" className="space-y-4">
                  {route.filteredDates.map(departure => (
                    <article
                      key={departure.iso}
                      role="listitem"
                      className="flex flex-col gap-3 p-3 bg-gray-50 rounded border"
                    >
                      <div className="flex-1">
                        <div className="font-medium text-lg">{departure.formatted}</div>
                        <div className="text-sm text-gray-500">{departure.weekday}</div>
                        {departure.isFullMoon && (
                          <span className="inline-flex items-center gap-1 mt-1" aria-label="Full Moon Departure">
                            ðŸŒ• Full Moon Departure
                          </span>
                        )}
                        {departure.fullMoonHint && !departure.isFullMoon && (
                          <div className="text-xs text-gray-400 mt-1">{departure.fullMoonHint}</div>
                        )}
                      </div>
                      <div className="flex flex-col sm:flex-row justify-between items-end gap-4">
                        <div className="text-sm text-right sm:text-left">
                          <div>Seats left: 15 {/* TODO: Customize seats placeholder */}</div>
                          <div className="font-semibold text-green-600">$2,500 {/* TODO: Customize price placeholder */}</div>
                        </div>
                        <div className="flex items-center gap-2">
                          <button
                            onClick={() =>
                              downloadICS({
                                summary: `Kailash Mansarovar - ${route.title} Departure`,
                                start: departure.iso,
                                details: `Departure: ${departure.formatted} (${departure.weekday})\nRoute: ${route.title}\nDuration: ${route.duration}\nFull Moon: ${departure.isFullMoon ? 'Yes' : 'No'}`
                              })
                            }
                            className="p-2 hover:bg-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                            aria-label="Download ICS calendar invite"
                            title="Download ICS"
                          >
                            ðŸ“…
                          </button>
                          <button
                            onClick={() =>
                              openGoogleCalendar({
                                summary: `Kailash Mansarovar - ${route.title} Departure`,
                                start: departure.iso,
                                details: `Departure: ${departure.formatted} (${departure.weekday})\nRoute: ${route.title}\nDuration: ${route.duration}\nFull Moon: ${departure.isFullMoon ? 'Yes' : 'No'}`
                              })
                            }
                            className="p-2 hover:bg-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                            aria-label="Add to Google Calendar"
                            title="Add to Google Calendar"
                          >
                            ðŸ”—
                          </button>
                          <button
                            onClick={() =>
                              handleBook({
                                iso: departure.iso,
                                date: departure.formatted,
                                weekday: departure.weekday,
                                route: route.title,
                                duration: route.duration,
                                isFullMoon: departure.isFullMoon
                              })
                            }
                            className="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 text-sm font-medium"
                          >
                            Book Now
                          </button>
                        </div>
                      </div>
                    </article>
                  ))}
                </div>
              )}
            </section>
          ))}
        </div>
      )}
    </div>
  );
};

export default KailashSchedule;

/*
Example usage:
<KailashSchedule year={2026} onBook={(dateObj) => console.log('Book:', dateObj)} />
*/
```

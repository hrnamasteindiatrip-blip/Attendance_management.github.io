<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Attendance Management System with Google Sheets</title>
    <style>
        /* CSS remains the same as before */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 1200px;
            min-height: 600px;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .nav-tab.active {
            background: white;
            border-bottom: 3px solid #4facfe;
            color: #4facfe;
            font-weight: bold;
        }

        .tab-content {
            padding: 30px;
            min-height: 500px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4facfe;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #06d6a0 0%, #118a7e 100%);
        }

        .attendance-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 30px;
        }

        .time-display {
            font-size: 48px;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 20px;
        }

        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin: 5px;
        }

        .status.checked-in {
            background: #d4edda;
            color: #155724;
        }

        .status.checked-out {
            background: #f8d7da;
            color: #721c24;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .records-table th {
            background: #4facfe;
            color: white;
            padding: 15px;
            text-align: left;
        }

        .records-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .records-table tr:hover {
            background: #f8f9fa;
        }

        .location-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #4facfe;
        }

        .stat-label {
            color: #666;
            margin-top: 10px;
        }

        .hidden {
            display: none !important;
        }

        .alert {
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        @media (max-width: 768px) {
            .container {
                width: 95%;
                margin: 10px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            .time-display {
                font-size: 36px;
            }
        }

        /* Admin specific styles */
        .admin-section {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            margin-top: 20px;
        }
        .admin-section h3 {
            margin-bottom: 15px;
            color: #333;
        }
        .admin-section .form-group {
            margin-bottom: 15px;
        }
        .admin-section .btn {
            margin-right: 10px;
        }
        .admin-table-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Employee Attendance Management System</h1>
            <p>Track attendance, manage leaves, and monitor employee activity with Google Sheets backend</p>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="alert alert-info" style="position: absolute; top: 0; left: 0; right: 0; z-index: 1000;">
            Loading data from Google Sheets...
        </div>

        <!-- Login Section -->
        <div id="loginSection">
            <div class="tab-content">
                <div class="login-form">
                    <h2 style="text-align: center; margin-bottom: 30px;">Login</h2>
                    <div class="form-group">
                        <label>Employee ID / Admin ID:</label>
                        <input type="text" id="employeeId" placeholder="Enter your ID">
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="password" placeholder="Enter your password">
                    </div>
                    <div class="form-group">
                        <button class="btn" style="width: 100%;" onclick="login()">Login</button>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 12px;">
                        <strong>Demo Credentials:</strong><br>
                        <strong>Admin:</strong> ADMIN / admin123<br>
                        <strong>Employees:</strong><br>
                        • EMP001 / password123<br>
                        • EMP002 / pass456<br>
                        • EMP003 / mike789
                    </div>
                    <div id="loginMessage"></div>
                </div>
            </div>
        </div>

        <!-- Main Application -->
        <div id="mainApp" class="hidden">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('dashboard')">Dashboard</button>
                <button class="nav-tab" onclick="showTab('attendance')">Mark Attendance</button>
                <button class="nav-tab" onclick="showTab('leave')">Leave Management</button>
                <button class="nav-tab" onclick="showTab('records')">My Records</button>
                <button class="nav-tab hidden" id="adminTab" onclick="showTab('admin')">Admin Panel</button>
                <button class="nav-tab" onclick="logout()" style="margin-left: auto; background: #ff6b6b; color: white;">Logout</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-pane active">
                <h2>Welcome, <span id="employeeName">Employee</span></h2>
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalDays">0</div>
                        <div class="stat-label">Days This Month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="presentDays">0</div>
                        <div class="stat-label">Present Days</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="leaveDays">0</div>
                        <div class="stat-label">Leave Days</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lateMarks">0</div>
                        <div class="stat-label">Late Marks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="halfDays">0</div>
                        <div class="stat-label">Half Days</div>
                    </div>
                </div>
                
                <div class="attendance-card">
                    <div class="time-display" id="currentTime"></div>
                    <div id="currentStatus"></div>
                    <div id="locationDisplay" class="location-info"></div>
                </div>
            </div>

            <!-- Attendance Tab -->
            <div id="attendance" class="tab-pane">
                <h2>Mark Attendance</h2>
                <div class="attendance-card">
                    <div class="time-display" id="attendanceTime"></div>
                    <div id="attendanceStatus"></div>
                    <div style="margin: 20px 0;">
                        <button class="btn btn-success" onclick="checkIn()">Check In</button>
                        <button class="btn btn-danger" onclick="checkOut()">Check Out</button>
                    </div>
                    <div id="locationInfo" class="location-info"></div>
                    <div id="attendanceMessage"></div>
                </div>
            </div>

            <!-- Leave Management Tab -->
            <div id="leave" class="tab-pane">
                <h2>Leave Management</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px;">
                    <div>
                        <h3>Apply for Leave</h3>
                        <div class="form-group">
                            <label>Leave Type:</label>
                            <select id="leaveType">
                                <option value="sick">Sick Leave</option>
                                <option value="casual">Casual Leave</option>
                                <option value="annual">Annual Leave</option>
                                <option value="emergency">Emergency Leave</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>From Date:</label>
                            <input type="date" id="fromDate">
                        </div>
                        <div class="form-group">
                            <label>To Date:</label>
                            <input type="date" id="toDate">
                        </div>
                        <div class="form-group">
                            <label>Reason:</label>
                            <textarea id="leaveReason" rows="4" placeholder="Enter reason for leave"></textarea>
                        </div>
                        <button class="btn" onclick="submitLeave()">Submit Leave Request</button>
                        <div id="leaveMessage"></div>
                    </div>
                    <div>
                        <h3>Leave Balance</h3>
                        <div class="stat-card">
                            <div class="stat-number">12</div>
                            <div class="stat-label">Sick Leave Remaining</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">18</div>
                            <div class="stat-label">Casual Leave Remaining</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">25</div>
                            <div class="stat-label">Annual Leave Remaining</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Records Tab -->
            <div id="records" class="tab-pane">
                <h2>My Records</h2>
                <div style="margin: 20px 0;">
                    <button class="btn" onclick="showAttendanceRecords()">Attendance Records</button>
                    <button class="btn" onclick="showLeaveRecords()">Leave Records</button>
                </div>
                <div id="recordsContent"></div>
            </div>

            <!-- Admin Panel Tab -->
            <div id="admin" class="tab-pane">
                <h2>Admin Panel</h2>
                <div class="admin-section">
                    <h3>Manage Employees</h3>
                    <div class="form-group">
                        <label>Employee ID:</label>
                        <input type="text" id="newEmployeeId" placeholder="e.g., EMP004">
                    </div>
                    <div class="form-group">
                        <label>Employee Name:</label>
                        <input type="text" id="newEmployeeName" placeholder="e.g., Alice Brown">
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="newEmployeePassword" placeholder="Set initial password">
                    </div>
                    <button class="btn btn-success" onclick="addEmployee()">Add Employee</button>
                    <button class="btn btn-danger" onclick="deleteEmployee()">Delete Employee</button>
                    <div id="employeeManagementMessage"></div>
                </div>

                <div class="admin-section">
                    <h3>View All Attendance Records</h3>
                    <div class="form-group">
                        <label>Filter by Employee ID (optional):</label>
                        <input type="text" id="filterEmployeeIdAttendance" onkeyup="viewAllAttendanceRecords()">
                    </div>
                    <button class="btn" onclick="viewAllAttendanceRecords()">Refresh Attendance</button>
                    <div class="admin-table-container" id="allAttendanceRecords"></div>
                </div>

                <div class="admin-section">
                    <h3>Manage Leave Requests</h3>
                    <div class="form-group">
                        <label>Filter by Employee ID (optional):</label>
                        <input type="text" id="filterEmployeeIdLeave" onkeyup="viewAllLeaveRequests()">
                    </div>
                    <button class="btn" onclick="viewAllLeaveRequests()">Refresh Leave Requests</button>
                    <div class="admin-table-container" id="allLeaveRequests"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Google Apps Script Web App URL - Replace this with your deployed Web App URL after setting up Apps Script in your Google Sheet
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxUcRnx4YGLQdp3SFn7fgBThjq_J7JD561nEv99nPR1pWk4rICm5WsqITcLk4lTuOjH/exec'; // Placeholder, replace with actual deployed URL

        // Sample employee data (for initial load, if sheet is empty)
        let employees = {
            'ADMIN': { name: 'Administrator', password: 'admin123', isAdmin: true },
            'EMP001': { name: 'John Doe', password: 'password123' },
            'EMP002': { name: 'Jane Smith', password: 'pass456' },
            'EMP003': { name: 'Mike Johnson', password: 'mike789' }
        };

        // In-memory data (for UI responsiveness)
        let attendanceData = {};
        let leaveData = {};
        let currentEmployee = null;
        let userLocation = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loadingOverlay').style.display = 'block';
            updateTime();
            setInterval(updateTime, 1000);
            getCurrentLocation();
            loadDataFromSheets().then(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
                addSampleDataIfEmpty();
            });
        });

        // Load data from Google Sheets
        async function loadDataFromSheets() {
            try {
                const empRes = await fetch(`${WEB_APP_URL}?action=getEmployees`);
                employees = await empRes.json();
                const attRes = await fetch(`${WEB_APP_URL}?action=getAttendance`);
                attendanceData = await attRes.json();
                const leaveRes = await fetch(`${WEB_APP_URL}?action=getLeaves`);
                leaveData = await leaveRes.json();
            } catch (e) {
                console.error('Error loading data from Google Sheets:', e);
                // Fallback to localStorage if available, but for production, handle errors
            }
        }

        // Save to Google Sheets (replace localStorage logic)
        async function saveToSheets(data, action) {
            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: action, data: data }),
                    headers: { 'Content-Type': 'application/json' }
                });
            } catch (e) {
                console.error('Error saving to Google Sheets:', e);
            }
        }

        // Add sample data if sheet is empty
        function addSampleDataIfEmpty() {
            if (Object.keys(employees).length <= 1) { // Assuming only placeholder
                Object.assign(employees, {});
                attendanceData = {};
                leaveData = {};
                addSampleData();
                saveAllToSheets();
            }
        }

        function saveAllToSheets() {
            // This is a batch save simulation; in Apps Script, implement batch updates
            // For simplicity, save individually
            for (const key in attendanceData) {
                for (const date in attendanceData[key]) {
                    saveToSheets(attendanceData[key][date], 'addAttendance');
                }
            }
            for (const key in leaveData) {
                leaveData[key].forEach(leave => {
                    saveToSheets(leave, 'addLeave');
                });
            }
        }

        function addSampleData() {
            // Sample data without duplicating
            const today = new Date();
            const yesterday = new Date();
            yesterday.setDate(today.getDate() - 1);
            
            const todayString = today.toDateString();
            const yesterdayString = yesterday.toDateString();
            
            attendanceData['EMP001'] = {
                [todayString]: {
                    checkIn: '09:15AM',
                    checkOut: '18:30PM',
                    isLate: true,
                    isHalfDay: false,
                    date: todayString,
                    status: 'Full Day'
                },
                [yesterdayString]: {
                    checkIn: '08:45AM',
                    checkOut: '17:45PM',
                    isLate: false,
                    isHalfDay: false,
                    date: yesterdayString,
                    status: 'Full Day'
                }
            };

            attendanceData['EMP002'] = {
                [todayString]: {
                    checkIn: '08:30AM',
                    checkOut: '12:30PM',
                    isLate: false,
                    isHalfDay: true,
                    date: todayString,
                    status: 'Half Day'
                }
            };

            leaveData['EMP003'] = [
                {
                    type: 'sick',
                    fromDate: '2025-09-10',
                    toDate: '2025-09-12',
                    reason: 'Medical consultation',
                    status: 'Pending'
                }
            ];

            leaveData['EMP001'] = [
                {
                    type: 'casual',
                    fromDate: '2025-09-15',
                    toDate: '2025-09-15',
                    reason: 'Personal work',
                    status: 'Approved'
                }
            ];
        }

        function login() {
            const empId = document.getElementById('employeeId').value.toUpperCase();
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('loginMessage');

            if (!empId || !password) {
                messageDiv.innerHTML = '<div class="alert alert-error">Please enter both ID and Password</div>';
                return;
            }

            if (employees[empId] && employees[empId].password === password) {
                currentEmployee = empId;
                document.getElementById('employeeName').textContent = employees[empId].name;
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                messageDiv.innerHTML = '';
                if (employees[empId].isAdmin) {
                    document.getElementById('adminTab').classList.remove('hidden');
                }
                updateDashboard();
            } else {
                messageDiv.innerHTML = '<div class="alert alert-error">Invalid ID or Password</div>';
            }
        }

        function logout() {
            currentEmployee = null;
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('employeeId').value = '';
            document.getElementById('password').value = '';
            document.getElementById('adminTab').classList.add('hidden');
        }

        function showTab(tabName) {
            const tabPanes = document.querySelectorAll('.tab-pane');
            tabPanes.forEach(pane => pane.classList.remove('active'));
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            if (tabName === 'admin') {
                viewAllAttendanceRecords();
                viewAllLeaveRequests();
            }
        }

        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            ['currentTime', 'attendanceTime'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = timeString;
            });
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        userLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        updateLocationDisplay();
                    },
                    error => {
                        userLocation = { error: 'Location unavailable' };
                        updateLocationDisplay();
                    }
                );
            }
        }

        function updateLocationDisplay() {
            const display = userLocation && !userLocation.error 
                ? `Lat: ${userLocation.latitude.toFixed(4)}, Long: ${userLocation.longitude.toFixed(4)}`
                : 'Location unavailable';
            ['locationDisplay', 'locationInfo'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = `<strong>Current Location:</strong> ${display}`;
            });
        }

        async function checkIn() {
            const now = new Date();
            const today = now.toDateString();
            if (!attendanceData[currentEmployee]) attendanceData[currentEmployee] = {};
            if (attendanceData[currentEmployee][today] && attendanceData[currentEmployee][today].checkIn) {
                document.getElementById('attendanceMessage').innerHTML = '<div class="alert alert-error">Already checked in today!</div>';
                return;
            }
            const isLate = now.getHours() > 9;
            attendanceData[currentEmployee][today] = {
                checkIn: now.toLocaleTimeString(),
                isLate: isLate,
                isHalfDay: false,
                date: today,
                status: 'Checked In'
            };
            await saveToSheets(attendanceData[currentEmployee][today], 'addAttendance');
            document.getElementById('attendanceMessage').innerHTML = '<div class="alert alert-success">Checked in successfully!</div>';
            updateAttendanceStatus();
            updateDashboard();
        }

        async function checkOut() {
            const today = new Date().toDateString();
            if (!attendanceData[currentEmployee] || !attendanceData[currentEmployee][today] || !attendanceData[currentEmployee][today].checkIn) {
                document.getElementById('attendanceMessage').innerHTML = '<div class="alert alert-error">Please check in first!</div>';
                return;
            }
            const now = new Date();
            attendanceData[currentEmployee][today].checkOut = now.toLocaleTimeString();
            const checkInTime = new Date(attendanceData[currentEmployee][today].checkIn);
            const hoursWorked = (now - checkInTime) / (1000 * 60 * 60);
            if (hoursWorked < 4) {
                attendanceData[currentEmployee][today].isHalfDay = true;
                attendanceData[currentEmployee][today].status = 'Half Day';
            } else if (hoursWorked < 8) {
                attendanceData[currentEmployee][today].status = 'Short Day';
            } else {
                attendanceData[currentEmployee][today].status = 'Full Day';
            }
            await saveToSheets(attendanceData[currentEmployee][today], 'addAttendance');
            document.getElementById('attendanceMessage').innerHTML = '<div class="alert alert-success">Checked out successfully!</div>';
            updateAttendanceStatus();
            updateDashboard();
        }

        function updateAttendanceStatus() {
            const today = new Date().toDateString();
            const record = attendanceData[currentEmployee]?.[today];
            let statusHtml = '<span class="status" style="background: #f8f9fa;">Not Marked</span>';
            if (record) {
                if (record.checkIn && !record.checkOut) {
                    statusHtml = '<span class="status checked-in">Checked In</span>';
                } else if (record.checkOut) {
                    statusHtml = `<span class="status checked-out">${record.status}</span>`;
                }
                if (record.isLate) statusHtml += '<span class="status">Late</span>';
                if (record.isHalfDay) statusHtml += '<span class="status">Half Day</span>';
            }
            ['currentStatus', 'attendanceStatus'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = statusHtml;
            });
        }

        async function submitLeave() {
            const type = document.getElementById('leaveType').value;
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const reason = document.getElementById('leaveReason').value;
            if (!fromDate || !toDate || !reason) {
                document.getElementById('leaveMessage').innerHTML = '<div class="alert alert-error">Fill all fields</div>';
                return;
            }
            if (new Date(fromDate) > new Date(toDate)) {
                document.getElementById('leaveMessage').innerHTML = '<div class="alert alert-error">Invalid dates</div>';
                return;
            }
            const leave = { empId: currentEmployee, type, fromDate, toDate, reason, status: 'Pending' };
            if (!leaveData[currentEmployee]) leaveData[currentEmployee] = [];
            leaveData[currentEmployee].push(leave);
            await saveToSheets(leave, 'addLeave');
            document.getElementById('leaveMessage').innerHTML = '<div class="alert alert-success">Leave submitted!</div>';
            document.getElementById('leaveReason').value = '';
            document.getElementById('fromDate').value = '';
            document.getElementById('toDate').value = '';
            updateDashboard();
        }

        function updateDashboard() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            let present = 0, late = 0, half = 0, leaveDays = 0;
            Object.values(attendanceData[currentEmployee] || {}).forEach(r => {
                const d = new Date(r.date);
                if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                    if (r.checkOut) present++;
                    if (r.isLate) late++;
                    if (r.isHalfDay) half++;
                }
            });
            (leaveData[currentEmployee] || []).forEach(l => {
                if (l.status === 'Approved') leaveDays++;
            });
            document.getElementById('totalDays').textContent = present;
            document.getElementById('presentDays').textContent = present - half;
            document.getElementById('lateMarks').textContent = late;
            document.getElementById('halfDays').textContent = half;
            document.getElementById('leaveDays').textContent = leaveDays;
            updateAttendanceStatus();
        }

        function showAttendanceRecords() {
            let html = '<h3>Attendance Records</h3><table class="records-table"><thead><tr><th>Date</th><th>Check In</th><th>Check Out</th><th>Late</th><th>Half Day</th><th>Status</th></tr></thead><tbody>';
            Object.values(attendanceData[currentEmployee] || {}).forEach(r => {
                html += `<tr><td>${r.date}</td><td>${r.checkIn || '-'}</td><td>${r.checkOut || '-'}</td><td>${r.isLate ? 'Yes' : 'No'}</td><td>${r.isHalfDay ? 'Yes' : 'No'}</td><td>${r.status || '-'}</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('recordsContent').innerHTML = html;
        }

        function showLeaveRecords() {
            let html = '<h3>Leave Records</h3><table class="records-table"><thead><tr><th>Type</th><th>From</th><th>To</th><th>Reason</th><th>Status</th></tr></thead><tbody>';
            (leaveData[currentEmployee] || []).forEach(l => {
                html += `<tr><td>${l.type}</td><td>${l.fromDate}</td><td>${l.toDate}</td><td>${l.reason}</td><td>${l.status}</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('recordsContent').innerHTML = html;
        }

        // Admin functions - Similar implementation, calling Google Sheets
        async function addEmployee() {
            const empId = document.getElementById('newEmployeeId').value.toUpperCase();
            const name = document.getElementById('newEmployeeName').value;
            const pass = document.getElementById('newEmployeePassword').value;
            if (!empId || !name || !pass) {
                document.getElementById('employeeManagementMessage').innerHTML = '<div class="alert alert-error">All fields required</div>';
                return;
            }
            employees[empId] = { name, password: pass, isAdmin: false };
            await saveToSheets({ empId, name, password: pass, isAdmin: false }, 'addEmployee');
            document.getElementById('employeeManagementMessage').innerHTML = '<div class="alert alert-success">Employee added!</div>';
        }

        async function deleteEmployee() {
            const empId = document.getElementById('newEmployeeId').value.toUpperCase();
            if (!empId || !employees[empId]) {
                document.getElementById('employeeManagementMessage').innerHTML = '<div class="alert alert-error">Invalid ID</div>';
                return;
            }
            delete employees[empId];
            delete attendanceData[empId];
            delete leaveData[empId];
            await saveToSheets({ empId }, 'deleteEmployee'); // Implement in Apps Script
            document.getElementById('employeeManagementMessage').innerHTML = '<div class="alert alert-success">Employee deleted!</div>';
        }

        async function viewAllAttendanceRecords() {
            await loadDataFromSheets(); // Refresh
            let html = '<table class="records-table"><thead><tr><th>EmpID</th><th>Name</th><th>Date</th><th>Check In</th><th>Check Out</th><th>Late</th><th>Half Day</th><th>Status</th></tr></thead><tbody>';
            const filter = document.getElementById('filterEmployeeIdAttendance').value.toUpperCase();
            Object.keys(attendanceData).forEach(id => {
                if (filter && id !== filter) return;
                Object.values(attendanceData[id]).forEach(r => {
                    html += `<tr><td>${id}</td><td>${employees[id]?.name || 'Unknown'}</td><td>${r.date}</td><td>${r.checkIn || '-'}</td><td>${r.checkOut || '-'}</td><td>${r.isLate ? 'Yes' : 'No'}</td><td>${r.isHalfDay ? 'Yes' : 'No'}</td><td>${r.status || '-'}</td></tr>`;
                });
            });
            html += '</tbody></table>';
            document.getElementById('allAttendanceRecords').innerHTML = html;
        }

        async function viewAllLeaveRequests() {
            await loadDataFromSheets();
            let html = '<table class="records-table"><thead><tr><th>EmpID</th><th>Name</th><th>Type</th><th>From</th><th>To</th><th>Reason</th><th>Status</th><th>Action</th></tr></thead><tbody>';
            const filter = document.getElementById('filterEmployeeIdLeave').value.toUpperCase();
            Object.keys(leaveData).forEach(id => {
                if (filter && id !== filter) return;
                leaveData[id].forEach(l => {
                    html += `<tr><td>${id}</td><td>${employees[id]?.name || 'Unknown'}</td><td>${l.type}</td><td>${l.fromDate}</td><td>${l.toDate}</td><td>${l.reason}</td><td>${l.status}</td><td><button class="btn btn-success" onclick="updateLeaveStatus('${id}', 0, 'Approved')">Approve</button><button class="btn btn-danger" onclick="updateLeaveStatus('${id}', 0, 'Rejected')">Reject</button></td></tr>`;
                });
            });
            html += '</tbody></table>';
            document.getElementById('allLeaveRequests').innerHTML = html;
        }

        async function updateLeaveStatus(empId, index, status) {
            leaveData[empId][index].status = status;
            await saveToSheets(leaveData[empId][index], 'updateLeave');
            viewAllLeaveRequests();
            updateDashboard();
        }
    </script>
</body>
</html>
</content>
</create_file>


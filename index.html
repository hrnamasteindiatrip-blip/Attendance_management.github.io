<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Attendance Management System with Google Sheets</title>
    <!-- Firebase SDK for Chat -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        /* Existing CSS remains unchanged */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 1200px;
            min-height: 600px;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .nav-tab.active {
            background: white;
            border-bottom: 3px solid #4facfe;
            color: #4facfe;
            font-weight: bold;
        }

        .tab-content {
            padding: 30px;
            min-height: 500px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4facfe;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #06d6a0 0%, #118a7e 100%);
        }

        .attendance-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 30px;
        }

        .time-display {
            font-size: 48px;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 20px;
        }

        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin: 5px;
        }

        .status.checked-in {
            background: #d4edda;
            color: #155724;
        }

        .status.checked-out {
            background: #f8d7da;
            color: #721c24;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .records-table th {
            background: #4facfe;
            color: white;
            padding: 15px;
            text-align: left;
        }

        .records-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .records-table tr:hover {
            background: #f8f9fa;
        }

        .location-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #4facfe;
        }

        .stat-label {
            color: #666;
            margin-top: 10px;
        }

        .hidden {
            display: none !important;
        }

        .alert {
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .container {
                width: 95%;
                margin: 10px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            .time-display {
                font-size: 36px;
            }
        }

        /* Admin specific styles */
        .admin-section {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            margin-top: 20px;
        }
        .admin-section h3 {
            margin-bottom: 15px;
            color: #333;
        }
        .admin-section .form-group {
            margin-bottom: 15px;
        }
        .admin-section .btn {
            margin-right: 10px;
        }
        .admin-table-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        /* Chat box styles */
        #chatContainer {
            border: 1px solid #ccc;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        #chatMessages div {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 5px;
            background: #fff;
        }
        #chatInputBox {
            display: flex;
            gap: 10px;
        }
        #chatInput {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #onlineUsers {
            margin-top: 15px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 8px;
        }
        #onlineUsers h4 {
            margin-bottom: 5px;
            color: #333;
        }
        #onlineUsersList {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #onlineUsersList li {
            padding: 3px 0;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Employee Attendance Management System</h1>
            <p>Track attendance, manage leaves, monitor locations, chat in-house, handle week-offs & holidays</p>
        </div>

        <!-- Login Section -->
        <div id="loginSection">
            <div class="tab-content">
                <div class="login-form">
                    <h2 style="text-align: center; margin-bottom: 30px;">Login</h2>
                    <div class="form-group">
                        <label>Employee ID / Admin ID:</label>
                        <input type="text" id="employeeId" placeholder="Enter your ID">
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="password" placeholder="Enter your password">
                    </div>
                    <div class="form-group">
                        <button class="btn" style="width: 100%;" onclick="login()">Login</button>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 12px;">
                        <strong>Demo Credentials:</strong><br>
                        <strong>Admin:</strong> ADMIN / admin123<br>
                        <strong>Employees:</strong><br>
                        - EMP001 / password123<br>
                        - EMP002 / pass456<br>
                        - EMP003 / mike789
                    </div>
                    <div id="loginMessage"></div>
                </div>
            </div>
        </div>

        <!-- Main Application -->
        <div id="mainApp" class="hidden">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('dashboard')">Dashboard</button>
                <button class="nav-tab" onclick="showTab('attendance')">Mark Attendance</button>
                <button class="nav-tab" onclick="showTab('leave')">Leave Management</button>
                <button class="nav-tab" onclick="showTab('records')">My Records</button>
                <button class="nav-tab hidden" id="adminTab" onclick="showTab('admin')">Admin Panel</button>
                <button class="nav-tab" onclick="showTab('chat')">In-House Chat</button>
                <button class="nav-tab" onclick="logout()" style="margin-left: auto; background: #ff6b6b; color: white;">Logout</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-pane active">
                <h2>Welcome, <span id="employeeName">Employee</span></h2>
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalDays">0</div>
                        <div class="stat-label">Days This Month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="presentDays">0</div>
                        <div class="stat-label">Present Days</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="leaveDays">0</div>
                        <div class="stat-label">Leave Days</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lateMarks">0</div>
                        <div class="stat-label">Late Marks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="halfDays">0</div>
                        <div class="stat-label">Half Days</div>
                    </div>
                </div>
                <div id="todayMessage" class="alert alert-info"></div>
                <div class="attendance-card">
                    <div class="time-display" id="currentTime"></div>
                    <div id="currentStatus"></div>
                    <div id="locationDisplay" class="location-info"></div>
                </div>
            </div>

            <!-- Attendance Tab -->
            <div id="attendance" class="tab-pane">
                <h2>Mark Attendance</h2>
                <div id="attendanceAlert"></div>
                <div class="attendance-card">
                    <div class="time-display" id="attendanceTime"></div>
                    <div id="attendanceStatus"></div>
                    <div style="margin: 20px 0;">
                        <button class="btn btn-success" id="checkInBtn" onclick="checkIn()">Check In</button>
                        <button class="btn btn-danger" id="checkOutBtn" onclick="checkOut()">Check Out</button>
                    </div>
                    <div id="locationInfo" class="location-info"></div>
                    <div id="attendanceMessage"></div>
                </div>
            </div>

            <!-- Leave Management Tab -->
            <div id="leave" class="tab-pane">
                <h2>Leave Management</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px;">
                    <div>
                        <h3>Apply for Leave</h3>
                        <div class="form-group">
                            <label>Leave Type:</label>
                            <select id="leaveType">
                                <option value="sick">Sick Leave</option>
                                <option value="casual">Casual Leave</option>
                                <option value="annual">Annual Leave</option>
                                <option value="emergency">Emergency Leave</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>From Date:</label>
                            <input type="date" id="fromDate">
                        </div>
                        <div class="form-group">
                            <label>To Date:</label>
                            <input type="date" id="toDate">
                        </div>
                        <div class="form-group">
                            <label>Reason:</label>
                            <textarea id="leaveReason" rows="4" placeholder="Enter reason for leave"></textarea>
                        </div>
                        <button class="btn" onclick="submitLeave()">Submit Leave Request</button>
                        <div id="leaveMessage"></div>
                    </div>
                    <div>
                        <h3>Leave Balance</h3>
                        <div class="stat-card">
                            <div class="stat-number">12</div>
                            <div class="stat-label">Sick Leave Remaining</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">18</div>
                            <div class="stat-label">Casual Leave Remaining</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">25</div>
                            <div class="stat-label">Annual Leave Remaining</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Records Tab -->
            <div id="records" class="tab-pane">
                <h2>My Records</h2>
                <div style="margin: 20px 0;">
                    <button class="btn" onclick="showAttendanceRecords()">Attendance Records</button>
                    <button class="btn" onclick="showLeaveRecords()">Leave Records</button>
                </div>
                <div id="recordsContent"></div>
            </div>

            <!-- Chat Tab -->
            <div id="chat" class="tab-pane">
                <h2>In-House Chat</h2>
                <div id="chatContainer">
                    <div id="chatMessages"></div>
                </div>
                <div id="chatInputBox">
                    <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="handleEnter(event)">
                    <button class="btn" onclick="sendMessage()">Send</button>
                </div>
                <div id="onlineUsers">
                    <h4>Online Employees:</h4>
                    <ul id="onlineUsersList">
                        <!-- Online users will be listed here -->
                    </ul>
                </div>
            </div>

            <!-- Admin Panel Tab -->
            <div id="admin" class="tab-pane">
                <h2>Admin Panel</h2>
                <div class="admin-section">
                    <h3>Manage Employees</h3>
                    <div class="form-group">
                        <label>Employee ID:</label>
                        <input type="text" id="newEmployeeId" placeholder="e.g., EMP004">
                    </div>
                    <div class="form-group">
                        <label>Employee Name:</label>
                        <input type="text" id="newEmployeeName" placeholder="e.g., Alice Brown">
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="newEmployeePassword" placeholder="Set initial password">
                    </div>
                    <button class="btn btn-success" onclick="addEmployee()">Add Employee</button>
                    <button class="btn btn-danger" onclick="deleteEmployee()">Delete Employee</button>
                    <div id="employeeManagementMessage"></div>
                </div>

                <div class="admin-section">
                    <h3>View All Attendance Records</h3>
                    <div class="form-group">
                        <label>Filter by Employee ID (optional):</label>
                        <input type="text" id="filterEmployeeIdAttendance" onkeyup="viewAllAttendanceRecords()">
                    </div>
                    <button class="btn" onclick="viewAllAttendanceRecords()">Refresh Attendance</button>
                    <div class="admin-table-container" id="allAttendanceRecords"></div>
                </div>

                <div class="admin-section">
                    <h3>Manage Leave Requests</h3>
                    <div class="form-group">
                        <label>Filter by Employee ID (optional):</label>
                        <input type="text" id="filterEmployeeIdLeave" onkeyup="viewAllLeaveRequests()">
                    </div>
                    <button class="btn" onclick="viewAllLeaveRequests()">Refresh Leave Requests</button>
                    <div class="admin-table-container" id="allLeaveRequests"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Google Apps Script Web App URL - REPLACE with your actual deployed URL
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxUzUuvCcJwiPuivx2Xa6p6EF59cFChiZqyNBKR-CGyGTfY9-q1gnSJfixZoS6Md5xAXg/exec'; // Replace here

        // Firebase Config - REPLACE with your actual config from Firebase console
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // Replace
            authDomain: "YOUR_PROJECT.firebaseapp.com", // Replace
            databaseURL: "https://YOUR_PROJECT.firebaseio.com", // Replace
            projectId: "YOUR_PROJECT", // Replace
            storageBucket: "YOUR_PROJECT.appspot.com", // Replace
            messagingSenderId: "SENDER_ID", // Replace
            appId: "APP_ID" // Replace
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Holiday and Week Off Logic
        const holidays = ['2024-12-25', '2025-01-01', '2025-08-15']; // Add more dates as YYYY-MM-DD

        function isSunday(date) {
            return date.getDay() === 0;
        }

        function isHoliday(date) {
            const dStr = date.toISOString().slice(0, 10);
            return holidays.includes(dStr);
        }

        function isNonWorkingDay(date) {
            return isSunday(date) || isHoliday(date);
        }

        function getNonWorkingMessage(date) {
            if (isHoliday(date)) return "Today is a holiday.";
            if (isSunday(date)) return "Today is week-off (Sunday).";
            return null;
        }

        // Sample employee data and other data as before
        let employees = {
            'ADMIN': { name: 'Administrator', password: 'admin123', isAdmin: true },
            'EMP001': { name: 'John Doe', password: 'password123' },
            'EMP002': { name: 'Jane Smith', password: 'pass456' },
            'EMP003': { name: 'Mike Johnson', password: 'mike789' }
        };
        let attendanceData = {};
        let leaveData = {};
        let currentEmployee = null;
        let userLocation = null;

        // Firebase references for presence
        const presenceRef = db.ref('presence');
        let userRef = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);
            getCurrentLocation();
            loadDataFromSheets().then(() => updateDashboard());
            updateAttendanceButtons();
            // Load chat
            db.ref('chat').on('child_added', snapshot => loadChatMessage(snapshot.val()));
            // Listen for presence changes
            presenceRef.on('value', snapshot => {
                updateOnlineUsers(snapshot.val());
            });
        });

        // Time and Location Updates
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('currentTime').textContent = timeString;
            document.getElementById('attendanceTime').textContent = timeString;
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        userLocation = {
                            latitude: pos.coords.latitude,
                            longitude: pos.coords.longitude,
                            accuracy: pos.coords.accuracy
                        };
                        updateLocationDisplays();
                    },
                    () => {
                        userLocation = { error: 'Unavailable' };
                        updateLocationDisplays();
                    }
                );
            } else {
                userLocation = { error: 'Geolocation not supported' };
                updateLocationDisplays();
            }
        }

        function updateLocationDisplays() {
            const display = userLocation && !userLocation.error ? `Lat: ${userLocation.latitude.toFixed(4)}, Long: ${userLocation.longitude.toFixed(4)}, Accuracy: ${userLocation.accuracy}m` : 'Location unavailable';
            ['locationDisplay', 'locationInfo'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = `<strong>Location:</strong> ${display}`;
            });
        }

        // Data Loading from Google Sheets
        async function loadDataFromSheets() {
            try {
                const empRes = await fetch(`${WEB_APP_URL}?action=getEmployees`);
                employees = await empRes.json();
                const attRes = await fetch(`${WEB_APP_URL}?action=getAttendance`);
                attendanceData = await attRes.json();
                const leaveRes = await fetch(`${WEB_APP_URL}?action=getLeaves`);
                leaveData = await leaveRes.json();
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        // Save to Google Sheets Function
        async function saveToSheets(data, action) {
            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: action, data: data }),
                    headers: { 'Content-Type': 'application/json' }
                });
            } catch (e) {
                console.error('Error saving:', e);
            }
        }

        function login() {
            const empId = document.getElementById('employeeId').value.toUpperCase();
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('loginMessage');

            if (!empId || !password) {
                messageDiv.innerHTML = '<div class="alert alert-error">Please enter ID and Password</div>';
                return;
            }

            if (employees[empId] && employees[empId].password === password) {
                currentEmployee = empId;
                document.getElementById('employeeName').textContent = employees[empId].name;
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                messageDiv.innerHTML = '';
                if (employees[empId].isAdmin) {
                    document.getElementById('adminTab').classList.remove('hidden');
                }
                updateDashboard();
                updateAttendanceButtons();

                // Set user presence in Firebase
                userRef = presenceRef.child(currentEmployee);
                userRef.set({
                    name: employees[currentEmployee].name,
                    status: 'online',
                    last_seen: firebase.database.ServerValue.TIMESTAMP
                });
                userRef.onDisconnect().remove(); // Remove user from presence when they disconnect

            } else {
                messageDiv.innerHTML = '<div class="alert alert-error">Invalid credentials</div>';
            }
        }

        function logout() {
            if (userRef) {
                userRef.remove(); // Remove user from presence when they log out
            }
            currentEmployee = null;
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('employeeId').value = '';
            document.getElementById('password').value = '';
            document.getElementById('adminTab').classList.add('hidden');
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.nav-tab[onclick="showTab('${tabName}')"]`).classList.add('active');
            if (tabName === 'admin') {
                viewAllAttendanceRecords();
                viewAllLeaveRequests();
            }
        }

        // Attendance Functions
        async function checkIn() {
            const now = new Date();
            const today = now.toDateString();
            if (isNonWorkingDay(now)) {
                document.getElementById('attendanceMessage').innerHTML = `<div class="alert alert-info">${getNonWorkingMessage(now)}</div>`;
                return;
            }
            if (!attendanceData[currentEmployee]) attendanceData[currentEmployee] = {};
            if (attendanceData[currentEmployee][today]?.checkIn) {
                document.getElementById('attendanceMessage').innerHTML = '<div class="alert alert-error">Already checked in today!</div>';
                return;
            }
            const isLate = now.getHours() > 9;
            attendanceData[currentEmployee][today] = {
                checkIn: now.toLocaleTimeString(),
                isLate: isLate,
                isHalfDay: false,
                date: today,
                status: 'Checked In',
                checkInLocation: userLocation ? {
                    lat: userLocation.latitude,
                    long: userLocation.longitude,
                    accuracy: userLocation.accuracy
                } : null
            };
            await saveToSheets(attendanceData[currentEmployee][today], 'addAttendance');
            document.getElementById('attendanceMessage').innerHTML = '<div class="alert alert-success">Checked in successfully!</div>';
            updateAttendanceStatus();
            updateDashboard();
        }

        async function checkOut() {
            const now = new Date();
            const today = now.toDateString();
            if (isNonWorkingDay(now)) {
                document.getElementById('attendanceMessage').innerHTML = `<div class="alert alert-info">${getNonWorkingMessage(now)}</div>`;
                return;
            }
            if (!attendanceData[currentEmployee][today]?.checkIn) {
                document.getElementById('attendanceMessage').innerHTML = '<div class="alert alert-error">Please check in first!</div>';
                return;
            }
            if (attendanceData[currentEmployee][today].checkOut) {
                document.getElementById('attendanceMessage').innerHTML = '<div class="alert alert-error">Already checked out today!</div>';
                return;
            }
            const checkInTime = new Date(attendanceData[currentEmployee][today].date + ' ' + attendanceData[currentEmployee][today].checkIn);
            const hoursWorked = (now - checkInTime) / (1000 * 60 * 60);
            if (hoursWorked < 4) {
                attendanceData[currentEmployee][today].isHalfDay = true;
                attendanceData[currentEmployee][today].status = 'Half Day';
            } else if (hoursWorked < 8) {
                attendanceData[currentEmployee][today].status = 'Short Day';
            } else {
                attendanceData[currentEmployee][today].status = 'Full Day';
            }
            attendanceData[currentEmployee][today].checkOut = now.toLocaleTimeString();
            attendanceData[currentEmployee][today].checkOutLocation = userLocation ? {
                lat: userLocation.latitude,
                long: userLocation.longitude,
                accuracy: userLocation.accuracy
            } : null;
            await saveToSheets(attendanceData[currentEmployee][today], 'addAttendance');
            document.getElementById('attendanceMessage').innerHTML = '<div class="alert alert-success">Checked out successfully!</div>';
            updateAttendanceStatus();
            updateDashboard();
        }

        function updateAttendanceStatus() {
            const today = new Date().toDateString();
            const record = attendanceData[currentEmployee]?.[today];
            let statusHtml = '<span class="status">Not Marked</span>';
            if (record) {
                if (record.checkIn && !record.checkOut) {
                    statusHtml = '<span class="status checked-in">Checked In</span>';
                } else if (record.checkOut) {
                    statusHtml = `<span class="status checked-out">${record.status}</span>`;
                }
                if (record.isLate) statusHtml += '<span class="status">Late</span>';
                if (record.isHalfDay) statusHtml += '<span class="status">Half Day</span>';
            }
            document.getElementById('currentStatus').innerHTML = statusHtml;
            document.getElementById('attendanceStatus').innerHTML = statusHtml;
        }

        function updateAttendanceButtons() {
            const now = new Date();
            const isOff = isNonWorkingDay(now);
            const checkInBtn = document.getElementById('checkInBtn');
            const checkOutBtn = document.getElementById('checkOutBtn');
            checkInBtn.disabled = isOff;
            checkOutBtn.disabled = isOff;
            const alertDiv = document.getElementById('attendanceAlert');
            if (isOff) {
                alertDiv.innerHTML = `<div class="alert alert-warning">${getNonWorkingMessage(now)} Attendance marking is disabled.</div>`;
                alertDiv.style.display = 'block';
            } else {
                alertDiv.style.display = 'none';
            }
        }

        // Other functions for leave, records, admin, dashboard as per previous code, with updates for weekends/holidays and vice versa
        async function submitLeave() {
            const type = document.getElementById('leaveType').value;
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const reason = document.getElementById('leaveReason').value;
            if (!fromDate || !toDate || !reason) {
                document.getElementById('leaveMessage').innerHTML = '<div class="alert alert-error">Fill all fields</div>';
                return;
            }
            if (new Date(fromDate) > new Date(toDate)) {
                document.getElementById('leaveMessage').innerHTML = '<div class="alert alert-error">Invalid dates</div>';
                return;
            }
            const leave = { empId: currentEmployee, type, fromDate, toDate, reason, status: 'Pending' };
            if (!leaveData[currentEmployee]) leaveData[currentEmployee] = [];
            leaveData[currentEmployee].push(leave);
            await saveToSheets(leave, 'addLeave');
            document.getElementById('leaveMessage').innerHTML = '<div class="alert alert-success">Leave submitted!</div>';
            document.getElementById('leaveReason').value = '';
            document.getElementById('fromDate').value = '';
            document.getElementById('toDate').value = '';
            updateDashboard();
        }

        function updateDashboard() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            let present = 0, late = 0, half = 0, leaveDays = 0;
            Object.values(attendanceData[currentEmployee] || {}).forEach(r => {
                const d = new Date(r.date);
                if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                    if (isNonWorkingDay(d)) {
                        r.status = getNonWorkingMessage(d);
                    } else if (r.checkOut) {
                        present++;
                    }
                    if (r.isLate) late++;
                    if (r.isHalfDay) half++;
                }
            });
            (leaveData[currentEmployee] || []).forEach(l => {
                if (l.status === 'Approved') leaveDays++;
            });
            document.getElementById('totalDays').textContent = present;
            document.getElementById('presentDays').textContent = present - half;
            document.getElementById('lateMarks').textContent = late;
            document.getElementById('halfDays').textContent = half;
            document.getElementById('leaveDays').textContent = leaveDays;
            updateAttendanceStatus();
            const today = new Date();
            const msg = getNonWorkingMessage(today);
            const todayMessageDiv = document.getElementById('todayMessage');
            if (msg) {
                todayMessageDiv.innerHTML = msg;
                todayMessageDiv.classList.remove('hidden');
            } else {
                todayMessageDiv.classList.add('hidden');
            }
        }

        function showAttendanceRecords() {
            let html = '<h3>Attendance Records</h3><table class="records-table"><thead><tr><th>Date</th><th>Check In</th><th>Check Out</th><th>Late</th><th>Half Day</th><th>Status</th></tr></thead><tbody>';
            Object.values(attendanceData[currentEmployee] || {}).forEach(r => {
                html += `<tr><td>${r.date}</td><td>${r.checkIn || '-'}</td><td>${r.checkOut || '-'}</td><td>${r.isLate ? 'Yes' : 'No'}</td><td>${r.isHalfDay ? 'Yes' : 'No'}</td><td>${r.status || '-'}</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('recordsContent').innerHTML = html;
        }

        function showLeaveRecords() {
            let html = '<h3>Leave Records</h3><table class="records-table"><thead><tr><th>Type</th><th>From</th><th>To</th><th>Reason</th><th>Status</th></tr></thead><tbody>';
            (leaveData[currentEmployee] || []).forEach(l => {
                html += `<tr><td>${l.type}</td><td>${l.fromDate}</td><td>${l.toDate}</td><td>${l.reason}</td><td>${l.status}</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('recordsContent').innerHTML = html;
        }

        // Chat Functions
        function sendMessage() {
            const msgInput = document.getElementById('chatInput');
            const message = msgInput.value.trim();
            if (!message) return;
            const chatRef = db.ref('chat');
            chatRef.push({
                empId: currentEmployee,
                sender: employees[currentEmployee]?.name || currentEmployee,
                message: message,
                timestamp: Date.now()
            });
            msgInput.value = '';
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function loadChatMessage(msg) {
            const time = new Date(msg.timestamp).toLocaleTimeString();
            const msgDiv = document.createElement('div');
            msgDiv.textContent = `[${time}] ${msg.sender}: ${msg.message}`;
            document.getElementById('chatMessages').appendChild(msgDiv);
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        }

        function updateOnlineUsers(presenceData) {
            const onlineUsersList = document.getElementById('onlineUsersList');
            onlineUsersList.innerHTML = ''; // Clear existing list

            if (presenceData) {
                Object.keys(presenceData).forEach(empId => {
                    const user = presenceData[empId];
                    const listItem = document.createElement('li');
                    listItem.textContent = user.name;
                    onlineUsersList.appendChild(listItem);
                });
            }
        }

        // Admin Functions
        async function addEmployee() {
            const empId = document.getElementById('newEmployeeId').value.toUpperCase();
            const name = document.getElementById('newEmployeeName').value;
            const pass = document.getElementById('newEmployeePassword').value;
            if (!empId || !name || !pass) {
                document.getElementById('employeeManagementMessage').innerHTML = '<div class="alert alert-error">All fields required</div>';
                return;
            }
            employees[empId] = { name, password: pass, isAdmin: false };
            await saveToSheets({ empId, name, password: pass, isAdmin: false }, 'addEmployee');
            document.getElementById('employeeManagementMessage').innerHTML = '<div class="alert alert-success">Employee added!</div>';
        }

        async function deleteEmployee() {
            const empId = document.getElementById('newEmployeeId').value.toUpperCase();
            if (!empId || !employees[empId]) {
                document.getElementById('employeeManagementMessage').innerHTML = '<div class="alert alert-error">ID required or not found</div>';
                return;
            }
            if (empId === 'ADMIN') {
                document.getElementById('employeeManagementMessage').innerHTML = '<div class="alert alert-error">Cannot delete ADMIN</div>';
                return;
            }
            if (confirm(`Delete ${employees[empId].name}?`)) {
                delete employees[empId];
                delete attendanceData[empId];
                delete leaveData[empId];
                // You may need to update Apps Script for deletion
                document.getElementById('employeeManagementMessage').innerHTML = '<div class="alert alert-success">Employee deleted!</div>';
            }
        }

        async function viewAllAttendanceRecords() {
            await loadDataFromSheets();
            let html = '<table class="records-table"><thead><tr><th>EmpID</th><th>Name</th><th>Date</th><th>Check In</th><th>Check Out</th><th>Late</th><th>Half Day</th><th>Status</th><th>Check-In Lat</th><th>Check-In Long</th><th>Check-In Accuracy (m)</th><th>Check-Out Lat</th><th>Check-Out Long</th><th>Check-Out Accuracy (m)</th></tr></thead><tbody>';
            const filter = document.getElementById('filterEmployeeIdAttendance').value.toUpperCase();
            Object.keys(attendanceData).forEach(id => {
                if (filter && id !== filter) return;
                Object.values(attendanceData[id]).forEach(r => {
                    const checkInLoc = r.checkInLocation || {};
                    const checkOutLoc = r.checkOutLocation || {};
                    html += `<tr><td>${id}</td><td>${employees[id]?.name || 'Unknown'}</td><td>${r.date}</td><td>${r.checkIn || '-'}</td><td>${r.checkOut || '-'}</td><td>${r.isLate ? 'Yes' : 'No'}</td><td>${r.isHalfDay ? 'Yes' : 'No'}</td><td>${r.status || '-'}</td><td>${checkInLoc.lat || '-'}</td><td>${checkInLoc.long || '-'}</td><td>${checkInLoc.accuracy || '-'}</td><td>${checkOutLoc.lat || '-'}</td><td>${checkOutLoc.long || '-'}</td><td>${checkOutLoc.accuracy || '-'}</td></tr>`;
                });
            });
            html += '</tbody></table>';
            document.getElementById('allAttendanceRecords').innerHTML = html;
        }

        async function viewAllLeaveRequests() {
            await loadDataFromSheets();
            let html = '<table class="records-table"><thead><tr><th>EmpID</th><th>Name</th><th>Type</th><th>From</th><th>To</th><th>Reason</th><th>Status</th><th>Action</th></tr></thead><tbody>';
            const filter = document.getElementById('filterEmployeeIdLeave').value.toUpperCase();
            Object.keys(leaveData).forEach(id => {
                if (filter && id !== filter) return;
                leaveData[id].forEach((l, idx) => {
                    const statusC = l.status === 'Approved' ? 'alert-success' : (l.status === 'Rejected' ? 'alert-error' : 'alert-info');
                    html += `<tr><td>${id}</td><td>${employees[id]?.name || 'Unknown'}</td><td>${l.type}</td><td>${l.fromDate}</td><td>${l.toDate}</td><td>${l.reason}</td><td class="${statusC}">${l.status}</td><td>${l.status === 'Pending' ? `<button class="btn btn-success" onclick="updateLeaveStatus('${id}', ${idx}, 'Approved')">Approve</button><button class="btn btn-danger" onclick="updateLeaveStatus('${id}', ${idx}, 'Rejected')">Reject</button>` : '-'}</td></tr>`;
                });
            });
            html += '</tbody></table>';
            document.getElementById('allLeaveRequests').innerHTML = html;
        }

        async function updateLeaveStatus(empId, index, status) {
            leaveData[empId][index].status = status;
            await saveToSheets(leaveData[empId][index], 'addLeave'); // Assume update
            viewAllLeaveRequests();
            updateDashboard();
        }
    </script>
</body>
</html>

